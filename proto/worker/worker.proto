syntax = "proto3";

package worker;

option go_package = "github.com/opensandbox/opensandbox/proto/worker";

service SandboxWorker {
  rpc CreateSandbox(CreateSandboxRequest) returns (CreateSandboxResponse);
  rpc DestroySandbox(DestroySandboxRequest) returns (DestroySandboxResponse);
  rpc GetSandbox(GetSandboxRequest) returns (GetSandboxResponse);
  rpc ListSandboxes(ListSandboxesRequest) returns (ListSandboxesResponse);

  rpc ExecCommand(ExecCommandRequest) returns (ExecCommandResponse);
  rpc ExecCommandStream(ExecCommandRequest) returns (stream ExecOutputChunk);

  rpc ReadFile(ReadFileRequest) returns (ReadFileResponse);
  rpc WriteFile(WriteFileRequest) returns (WriteFileResponse);
  rpc ListDir(ListDirRequest) returns (ListDirResponse);

  rpc CreatePTY(CreatePTYRequest) returns (CreatePTYResponse);
  rpc PTYStream(stream PTYInput) returns (stream PTYOutput);

  rpc HibernateSandbox(HibernateSandboxRequest) returns (HibernateSandboxResponse);
  rpc WakeSandbox(WakeSandboxRequest) returns (WakeSandboxResponse);
  rpc IsTAPAvailable(IsTAPAvailableRequest) returns (IsTAPAvailableResponse);

  rpc SaveAsTemplate(SaveAsTemplateRequest) returns (SaveAsTemplateResponse);

  rpc BuildTemplate(BuildTemplateRequest) returns (BuildTemplateResponse);

  rpc GetSandboxStats(GetSandboxStatsRequest) returns (GetSandboxStatsResponse);
}

message CreateSandboxRequest {
  string template = 1;
  int32 timeout = 2;
  map<string, string> envs = 3;
  int32 memory_mb = 4;
  int32 cpu_count = 5;
  bool network_enabled = 6;
  string image_ref = 7;
  int32 port = 8;  // container port to expose via subdomain (default 80)
  // Sandbox snapshot template: if non-empty, boot from these S3 keys instead of base image.
  string template_rootfs_key = 9;
  string template_workspace_key = 10;
}

message CreateSandboxResponse {
  string sandbox_id = 1;
  string status = 2;
}

message DestroySandboxRequest {
  string sandbox_id = 1;
}

message DestroySandboxResponse {}

message GetSandboxRequest {
  string sandbox_id = 1;
}

message GetSandboxResponse {
  string sandbox_id = 1;
  string status = 2;
  string template = 3;
  int64 started_at = 4;
  int64 end_at = 5;
}

message ListSandboxesRequest {}

message ListSandboxesResponse {
  repeated GetSandboxResponse sandboxes = 1;
}

message ExecCommandRequest {
  string sandbox_id = 1;
  string command = 2;
  repeated string args = 3;
  map<string, string> envs = 4;
  string cwd = 5;
  int32 timeout = 6;
}

message ExecCommandResponse {
  int32 exit_code = 1;
  string stdout = 2;
  string stderr = 3;
}

message ExecOutputChunk {
  enum Stream {
    STDOUT = 0;
    STDERR = 1;
  }
  Stream stream = 1;
  bytes data = 2;
}

message ReadFileRequest {
  string sandbox_id = 1;
  string path = 2;
}

message ReadFileResponse {
  bytes content = 1;
}

message WriteFileRequest {
  string sandbox_id = 1;
  string path = 2;
  bytes content = 3;
}

message WriteFileResponse {}

message ListDirRequest {
  string sandbox_id = 1;
  string path = 2;
}

message DirEntry {
  string name = 1;
  bool is_dir = 2;
  int64 size = 3;
  string path = 4;
}

message ListDirResponse {
  repeated DirEntry entries = 1;
}

message CreatePTYRequest {
  string sandbox_id = 1;
  int32 cols = 2;
  int32 rows = 3;
  string shell = 4;
}

message CreatePTYResponse {
  string session_id = 1;
}

message PTYInput {
  string session_id = 1;
  oneof input {
    bytes data = 2;
    PTYResize resize = 3;
  }
}

message PTYResize {
  int32 cols = 1;
  int32 rows = 2;
}

message PTYOutput {
  string session_id = 1;
  bytes data = 2;
}

message HibernateSandboxRequest {
  string sandbox_id = 1;
}

message HibernateSandboxResponse {
  string sandbox_id = 1;
  string checkpoint_key = 2;
  int64 size_bytes = 3;
}

message WakeSandboxRequest {
  string sandbox_id = 1;
  string checkpoint_key = 2;
  int32 timeout = 3;
}

message WakeSandboxResponse {
  string sandbox_id = 1;
  string status = 2;
}

message IsTAPAvailableRequest {
  string sandbox_id = 1;
}

message IsTAPAvailableResponse {
  bool available = 1;
}

message SaveAsTemplateRequest {
  string sandbox_id = 1;
  string template_id = 2;  // UUID assigned by control plane
}

message SaveAsTemplateResponse {
  string rootfs_s3_key = 1;
  string workspace_s3_key = 2;
}

message BuildTemplateRequest {
  string name = 1;
  string dockerfile = 2;
  string tag = 3;
  string ecr_image_ref = 4;
}

message BuildTemplateResponse {
  string image_ref = 1;
  string build_log = 2;
}

message GetSandboxStatsRequest {
  string sandbox_id = 1;
}

message GetSandboxStatsResponse {
  double cpu_percent = 1;
  uint64 mem_usage = 2;
  uint64 mem_limit = 3;
  uint64 net_input = 4;
  uint64 net_output = 5;
  int32 pids = 6;
}
